[TOC]

### zookeeper由来
>①各节点数据一致性；  
②怎么保证任务只在一个节点执行；  
③若其中一个节点挂了，其他节点如何发现并接替；  
④存在共享资源，互斥性、安全性。

>分布式系统的很多难题，都是由缺少协调机制造成。分布式协调做的较好的：Google Chubby、Apache Zookeeper。  
Google Chubby是一个分布式锁服务，解决分布式协作、Master选举等与分布式锁服务相关问题。  
Zookeeper也类似，在雅虎内部很多系统都需依赖一个系统来分布式协调，但谷歌的Chubby不开源，故雅虎基于Chubby的思想开发了zookeeper并捐赠给Apache。  
zookeeper架构，可用来解决task多实例执行问题，各服务先去zookeeper上注册节点，然后获得权限后再来访问task。

### zookeeper设计猜想
>主要解决分布式环境的服务协调问题，若实现一个zookeeper中间件需做啥？  
>- ①防单点故障：做集群，且集群若要满足高性能要求，还得是一个高性能、高可用集群。高性能意味该集群能够分担客户端的请求流量，高可用意味集群中某节点宕机后，不影响整个集群的数据和继续提供服务的可能性。    
结论：该中间件需考虑集群,且该集群还需分摊客户端的请求流量；  
>- ②要满足高性能，每个节点都能接到请求，且每个节点数据都必须保持一致。实现各节点数据一致性，要有一个 leader节点负责协调和数据同步操作。若集群无leader节点，每个节点都可接收所有请求，那该集群的数据同步复杂度很大。  
结论：该集群涉及数据同步，会存在leader节点；  
>- ③如何选举leader节点，leader挂了后，如何恢复？  
结论：zookeeper基于paxos理论衍生出ZAB协议；    
>- ④leader节点如何和其他节点保证数据一致性，且要求强一致。  
分布式系统中，每个节点虽都能知道自己的事务操作过程是成功/失败，却无法直接获取其他分布式节点的操作结果。故当一个事务操作涉及到跨节点时，就需用到分布式事务。  
分布式事务的数据一致性协议：2PC协议和3PC协议。

>基于如上猜想，基本知道zookeeper为何要用到zab理论做选举、为何要做集群、为何要用到分布式事务实现数据一致性。

#### 2PC提交
>Two Phase Commitment Protocol，当一个事务需跨越多个分布式节点时，为保持ACID特性，需引入一个协调者（TM）来统一调度所有分布式节点的执行逻辑，分布式节点被称为AP。TM负责调度AP的行为，最终决定AP是否提交事务；整个事务分为两个阶段提交，故称2PC。

>TM（或许是个进程）通常是由TPM（transaction processing monitor）提供。  
角色：①AP:application应用节点；②RM:resource manager资源管理器，一般是数据库文件系统之类；③TM:transaction manager事务管理器、事务协调者，负责解释AP发起的事务指令，调度协调参与者所有RM的协调，确保事务正常完成。
##### 阶段一：提交事务请求（投票）
>①事务询问：协调者向所有参与者发送事务内容，询问是否可执行事务提交，等待各参与者响应；  
②执行事务：各参与者执行事务，将Undo和Redo信息记录到事务日志，尽量把提交过程中所有消耗时间的操作和
准备都提前完成确保后面100%成功提交事务；  
③各参与者向协调者反馈事务询问的响应：若各参与者成功执行事务，则反馈给协调者yes的响应，表示事务可执行；若参与者没成功执行事务，则反馈给协调者no的响应，表示事务不可执行。该阶段类似协调者组织各参与者对一次事务操作的投票表态过程，因此2pc协议的第一个阶段称为“投票阶段”，即各参与者投票表明是否需继续执行事务提交。
##### 阶段二：执行事务提交
>该阶段，协调者根据各参与者的反馈情况决定最终的事务提交操作，包含两种可能:执行事务、中断事务。

### 集群
>zookeeper中，客户端会随机连接到zookeeper集群中的一个节点。若是读请求，直接从当前节点读取数据；若是写请求，会被转发给leader提交事务，leader会广播事务，只要有超过半数节点写入成功，那么写请求就会被提交（类 2PC 事务）所有事务请求必须由一个全局唯一的服务器来协调处理，
这个服务器就是 Leader 服务器，其他的服务器就是
follower。 leader 服务器把客户端的失去请求转化成一个事
务 Proposal（提议） ，并把这个 Proposal 分发给集群中的
所有 Follower 服务器。之后 Leader 服务器需要等待所有
https://blog.csdn.net/qq_16038125/article/details/80920240